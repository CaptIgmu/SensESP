var globalEditor=null,deviceInfo=null,currentPage="info",pagesLoaded=!1,targets={};function ajax(method,url,data,contentType){return new Promise((function(resolve,reject){var request=new XMLHttpRequest;request.open(method,url,!0),request.onload=function(){200===request.status?resolve(request.response):reject(Error(request.statusText))},request.onerror=function(){reject(Error("Network Error"))},contentType&&request.setRequestHeader("Content-Type",contentType),request.send(data)}))}class NavTarget{constructor(key,invokeFunction,link){this.Key=key,this.TargetFunction=invokeFunction,this.Link=link}}function getEmptyContentDiv(){var main=document.getElementById("content");return main.empty(),globalEditor=null,main}function editConfig(config_path){var main=getEmptyContentDiv();showLoader(!0,"Loading configuration from device..."),ajax("GET","/config"+config_path).then((response=>{showLoader(!1);var json=JSON.parse(response),config=json.config,schema=json.schema;0!=Object.keys(schema).length?(schema.title||(schema.title=`Configuration for ${config_path}`),main.innerHTML="<div class='row g-3 m-4'>\n        <div id='editor_holder'></div>\n        <div class='col-12'>\n        <button id='submit' type='button' class='btn btn-primary'>Save</button>\n        <span id='valid_indicator' class='label ms-5'></span>\n        </div>\n        </div>",globalEditor=new JSONEditor(document.getElementById("editor_holder"),{schema:schema,startval:config,no_additional_properties:!0,disable_collapse:!0,disable_properties:!0,disable_edit_json:!0,show_opt_in:!0,theme:"bootstrap4"}),document.getElementById("submit").addEventListener("click",(function(){saveConfig(config_path,globalEditor.getValue())})),globalEditor.on("change",(function(){var errors=globalEditor.validate(),indicator=document.getElementById("valid_indicator");errors.length?(indicator.className="text-danger",indicator.textContent="not valid"):(indicator.className="text-success",indicator.textContent="valid")}))):alert(`No schema available for ${config_path}`)})).catch((err=>{showLoader(!1),alert(`Error retrieving configuration ${config_path}: ${err.message}`)}))}function saveConfig(config_path,values){showLoader(!0,"Saving configuration..."),ajax("PUT","/config"+config_path,JSON.stringify(values),"application/json").then((response=>{showLoader(!1)})).catch((err=>{showLoader(!1),alert(`Error saving configuration ${config_path}: ${err.message}`)}))}function showLoader(show,status){var loader=document.getElementById("loader");show?(null!=status&&null!=status||(status="Loading..."),loadertext.innerHTML=status,loader.classList.remove("visually-hidden")):loader.classList.add("visually-hidden")}function executeCommand(name,shouldConfirm){(1!=shouldConfirm||confirm("Execute "+name+"?"))&&(showLoader(!0,"Executing "+name+"..."),ajax("GET","/command?id="+name).then((r=>{showLoader(!1),alert(r)})).catch((err=>{showLoader(!1),alert(err)})))}function showAdvanced(){var div=getEmptyContentDiv(),content='\n    <div class=\'card\'>\n        <div class="card-body">\n        <h5 class="card-title mb-4">Device commands</h5>\n        <a href="/device/restart" onclick=\'return confirm("Restart device?");\' class="btn btn-primary">Restart</a>\n        <a href="/device/reset" onclick=\'return confirm("Are you sure you want to reset device to factory settings?");\' class="btn btn-danger">Reset to defaults</a>\n        </div>\n    </div>',commands=deviceInfo.Commands;if(commands.length>0){content+="<div class='card mt-3'><div class='card-body'><h5 class='card-title mb-4'>Custom commands</h5>";for(var i=0;i<commands.length;i++){var command=commands[i];content+=`<a class="btn btn-primary" onclick="executeCommand('${command.Name}',${command.Confirm})" href="#">${command.Title}</a>`}content+="</div></div>",div.innerHTML=content}}function showCustom(target){showLoader(!0),ajax("GET",target.Link).then((v=>{showLoader(!1),getEmptyContentDiv().innerHTML="<h1>"+target.Key+"</h1>"+v})).catch((err=>{showLoader(!1),alert(err)}))}function loadInfo(){ajax("GET","/info").then((response=>{deviceInfo=JSON.parse(response);var content=getEmptyContentDiv();for(const property in deviceInfo.Properties){var value=deviceInfo.Properties[property];content.innerHTML+="<div class='mb-3'><label class='form-label'>"+property+"</label><input type='text' readonly class='form-control' value='"+value+"'></div>","Name"===property&&(document.getElementById("devicename").innerHTML=value,document.title=value+" - WebUI")}if(!pagesLoaded){pagesLoaded=!0;var mainMenu=document.getElementById("mainmenu");for(const page in deviceInfo.Pages){var link=deviceInfo.Pages[page],navItem=document.createElement("li");navItem.innerHTML="<a href='#' data-target='"+page+"' class='nav-link' aria-current='page'>"+page+"</a></li>",mainMenu.append(navItem),targets[page]=new NavTarget(page,showCustom,link)}for(var configmenu=document.getElementById("configmenu"),lastRoot=null,i=0;i<deviceInfo.Config.length;i++){var configPath=deviceInfo.Config[i],parts=configPath.split("/"),rootName=parts[1];rootName=rootName[0].toUpperCase()+rootName.substring(1),null!=lastRoot&&lastRoot==rootName||(null!=lastRoot&&(configmenu.innerHTML+="<li><hr class='dropdown-divider'></li>"),configmenu.innerHTML+="<li class='d-flex align-items-center mb-1'><svg class='ms-2' width='16' height='16' viewBox='0 0 32 32'><use xlink:href='#i-settings'/></svg>&nbsp;<span class='text-center'>"+rootName+"</span></li>",lastRoot=rootName);var linkName=parts[parts.length-1];linkName=linkName[0].toUpperCase()+linkName.substring(1),configmenu.innerHTML+="<li><a class='dropdown-item d-flex align-items-center' onclick='editConfig(\""+configPath+"\");' href='#'><span class='d-inline-block bg-primary rounded-circle' style='width: .5em;height:0.5em'></span>&nbsp;"+linkName+"</a></li>"}document.getElementById("configdrop").addEventListener("click",(()=>{configmenu.classList.contains("show")?configmenu.classList.remove("show"):configmenu.classList.add("show")}))}showLoader(!1)})).catch((err=>{alert("Device info load failed: "+err.statusText)}))}function initialize(){loadInfo(),targets.status=new NavTarget("status",loadInfo),targets.advanced=new NavTarget("advanced",showAdvanced),document.getElementById("mainmenu").addEventListener("click",(e=>{var targetKey=e.target.dataset.target,target=targets[targetKey];null!=target&&target.TargetFunction(target)}))}Element.prototype.empty=function(){for(var child=this.lastElementChild;child;)this.removeChild(child),child=this.lastElementChild};
